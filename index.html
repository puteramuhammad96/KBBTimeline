<!doctype html><html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>KBB Timeline ‚Äî Final Fixed (All-in-One)</title>
<style>
:root{
  --bg:#0a0a0a;--panel:#121212;--ink:#e5e5e5;--muted:#9ca3af;
  --amber:#fbbf24;--amber600:#f59e0b;--border:#27272a;--red:#ef4444;
}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:var(--bg);color:var(--ink)}
.container{max-width:1200px;margin:0 auto;padding:24px}
.header{display:flex;gap:12px;align-items:flex-end;justify-content:space-between;flex-wrap:wrap}
.h-title{font-size:28px;font-weight:700;letter-spacing:-.01em}.h-sub{color:var(--muted)}
.controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.chip{background:rgba(251,191,36,.12);color:var(--amber);padding:6px 10px;border-radius:999px;border:1px solid rgba(251,191,36,.25);font-size:13px}
.button{background:#0b0b0b;border:1px solid var(--border);color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}
.button.active{background:#161616;color:#fff}
.panel{background:#121212;border:1px solid var(--border);border-radius:16px;padding:12px}
.gridhead{display:grid;grid-template-columns:1.5fr .5fr;gap:12px}
.input{width:100%;padding:10px;border-radius:12px;background:#0b0b0b;border:1px solid var(--border);color:var(--ink);outline:none}
.input:focus{border-color:var(--amber)}
.card{background:#18181b;border:1px solid var(--border);border-radius:16px;padding:16px}
.legend{font-size:12px;color:var(--muted);margin-top:8px}

/* Gantt layout */
.gantt{border:1px solid var(--border);border-radius:12px;overflow:auto;position:relative;min-height:420px}
.table{display:grid;grid-template-columns:320px 1fr;min-width:980px}
.left{position:sticky;left:0;background:#0f0f0f;border-right:1px solid var(--border);z-index:2}
.lrow{padding:8px 10px;border-bottom:1px solid var(--border);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.lrow.group{font-weight:700}
.right{position:relative}
.rh{position:sticky;top:0;background:#0f0f0f;border-bottom:1px solid var(--border);z-index:1}
.monthbar{height:28px;display:flex;align-items:center;font-size:12px;color:#cbd5e1;border-bottom:1px solid #1f1f1f}
.scale2{height:26px;display:flex;align-items:center;font-size:12px;color:#a1a1aa;border-bottom:1px solid #1f1f1f}
.seg{display:flex;align-items:center;justify-content:flex-start;padding:0 8px;border-right:1px solid #1f1f1f}
.rgrid{position:relative}
.rrow{height:32px;border-bottom:1px dashed #1f1f1f}

/* Drawing */
.tl{position:absolute;width:2px;background:var(--red);z-index:5;pointer-events:none}
.bar{position:absolute;height:22px;border-radius:6px;transform:translateY(-50%);cursor:pointer;color:#0b0b0b;font-size:12px;display:flex;align-items:center;justify-content:center;padding:0 6px;border:1px solid #3f3f46;background:linear-gradient(90deg,#6b7280,#4b5563)}
.bar.done{background:linear-gradient(90deg,var(--amber),var(--amber600));border-color:rgba(251,191,36,.35)}
.tooltip{position:absolute;background:#111;border:1px solid #333;color:#fff;font-size:12px;padding:8px 10px;border-radius:8px;max-width:280px;z-index:10;box-shadow:0 0 8px rgba(0,0,0,.45)}
.tooltip button{margin-top:6px;padding:4px 8px;border:0;border-radius:6px;background:#d97706;color:#fff;cursor:pointer}
.small{font-size:12px;color:#9ca3af}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div>
      <div class="h-title">KBB Steakhouse Project Timeline</div>
      <div class="h-sub">Kuala Terengganu ‚Ä¢ Nov‚ÄìDec 2025</div>
    </div>
    <div class="controls">
      <div class="chip" id="overallChip">Overall: 0%</div>
      <button class="button" id="resetBtn">üîÅ Reset Progress</button>
      <div class="button-group">
        <button class="button active" data-scale="day">Day</button>
        <button class="button" data-scale="week">Week</button>
        <button class="button" data-scale="month">Month</button>
      </div>
    </div>
  </div>

  <div class="gridhead">
    <div class="panel"><div class="small">Cari task</div>
      <input id="search" class="input" placeholder="Contoh: Ceiling, Signage, Plumbing">
    </div>
    <div class="panel" style="display:flex;align-items:center;justify-content:space-between">
      <div><div class="small">Status</div><div style="font-size:20px;color:var(--amber)" id="statusNum">0%</div></div>
      <div style="text-align:right"><div class="small">Total Duration</div><div style="font-size:20px" id="duration">‚Äî</div></div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div id="gantt" class="gantt"></div>
    <div class="legend">üö© Garis merah = tarikh hari ini ‚Ä¢ Hover/klik bar untuk info ‚Ä¢ Klik untuk tandakan siap ‚Ä¢ Reset untuk kosongkan status.</div>
  </div>
</div>

<script>
/* ================== DATA ================== */
const RAW = [
 ["0","KBB STEAKHOUSE, KUALA TERENGGANU","2025-11-06","2025-12-04",0,1,"0",""],
 ["1","Site Preparation","2025-11-06","2025-11-07",0,0,"0",""],
 ["2","Manufacture Site Hoarding","2025-11-06","2025-11-06",0,0,"1",""],
 ["3","Install Site Hoarding","2025-11-07","2025-11-07",0,0,"1","2"],
 ["4","Circular Wing (Cover Dining & Toilet)","2025-11-08","2025-12-04",0,1,"0","3"],
 ["5","Site Delivery","2025-11-08","2025-11-11",0,0,"4","3"],
 ["6","Marking Demolition Items/Location","2025-11-08","2025-11-08",0,0,"4","5"],
 ["7","Demolish Floor Finish, Handwash & Steel Cage","2025-11-08","2025-11-10",0,0,"4","6"],
 ["8","Erect Brickwall Exterior","2025-11-08","2025-11-13",0,0,"4","7,5"],
 ["9","Plumbing Line for Handwash Area","2025-11-10","2025-11-11",0,0,"4","7"],
 ["10","Erect Bricks at Toilet (Set Pipe)","2025-11-11","2025-11-12",0,0,"4","9"],
 ["11","Erect Brickwalls at Photo Area","2025-11-12","2025-11-14",0,0,"4","10"],
 ["12","Install Fittings at Toilet","2025-11-13","2025-11-14",0,0,"4","8"],
 ["13","Install Tiles at Toilet","2025-11-14","2025-11-16",0,0,"4","12"],
 ["14","Brickwalls & Top at Middle Column","2025-11-14","2025-11-16",0,0,"4","11"],
 ["15","Floor Tiles at Dining Area","2025-11-16","2025-11-20",0,0,"4","14"],
 ["16","Tiles at Handwash Area","2025-11-16","2025-11-18",0,0,"4","13"],
 ["17","Measurement for Glass Door","2025-11-13","2025-11-14",0,0,"4","8"],
 ["23","Ceiling Work (Frame)","2025-11-18","2025-11-19",0,0,"4","16"],
 ["18","Set Out & Material ‚Äì Electrical","2025-11-19","2025-11-21",0,0,"4","23"],
 ["19","Wiring & Piping Relocation","2025-11-21","2025-11-23",0,0,"4","18"],
 ["20","Set Out & Material ‚Äì Aircond","2025-11-23","2025-11-24",0,0,"4","19"],
 ["21","Aircond Installation","2025-11-24","2025-11-25",0,0,"4","20"],
 ["37","Install Ceiling","2025-11-23","2025-11-25",0,0,"30","36,35"],
 ["22","Plastering Work","2025-11-25","2025-11-29",0,0,"4","15,19,37"],
 ["24","Ceiling Finishes","2025-11-25","2025-11-26",0,0,"4","21,23,39"],
 ["40","Paint Work (Main Wing)","2025-11-25","2025-11-28",0,0,"30","37"],
 ["41","Install Cabinetry (Main Wing)","2025-11-28","2025-11-29",0,0,"30","40"],
 ["25","Paint Work (Circular Wing)","2025-11-29","2025-12-02",0,0,"4","22,24"],
 ["26","Install Cabinetry (Circular Wing)","2025-11-29","2025-11-30",0,0,"4","41"],
 ["27","Install Steel Structure","2025-11-30","2025-12-02",0,0,"4","26"],
 ["28","Install Signage (Circular Wing)","2025-12-02","2025-12-04",0,0,"4","25,27"],
 ["29","Install Door","2025-12-02","2025-12-04",0,0,"4","28,17"],
 ["30","Main Wing","2025-11-16","2025-12-04",0,1,"0",""],
 ["31","Demolish Floor Finish (Main)","2025-11-16","2025-11-19",0,0,"30","15"],
 ["32","Demolish Wall Finish to Exposed Brick","2025-11-16","2025-11-19",0,0,"30","31"],
 ["33","Demolish Ceiling (Main)","2025-11-16","2025-11-19",0,0,"30","32"],
 ["34","Set Out & Material ‚Äì Electrical (Main)","2025-11-19","2025-11-21",0,0,"30","31,32,33"],
 ["35","Wiring & Piping Relocation (Main)","2025-11-21","2025-11-23",0,0,"30","34"],
 ["36","Wall Mod (VIP Room ‚Äì Shera)","2025-11-19","2025-11-22",0,0,"30","31,32,33"],
 ["38","Outdoor Touch Up (Demo/Render/Gravel)","2025-11-19","2025-11-23",0,0,"30","23"],
 ["39","Tiles at Foyer","2025-11-23","2025-11-25",0,0,"30","38"],
 ["42","Install Signage (Main)","2025-12-02","2025-12-04",0,0,"30","41,28"]
];

/* ============== UTILITIES ============== */
const $=s=>document.querySelector(s), $$=s=>[...document.querySelectorAll(s)];
const parse=d=>new Date(d+"T00:00:00");
const dBetween=(a,b)=>Math.max(1,Math.round((parse(b)-parse(a))/86400000));
const dDiff=(a,b)=>Math.round((parse(b)-parse(a))/86400000);
const startProj=RAW.find(t=>t[0]==="0")[2], endProj=RAW.find(t=>t[0]==="0")[3];
const nameMap={}; RAW.forEach(t=>nameMap[t[0]]=t[1]);
const children=id=>RAW.filter(t=>t[6]==id);
const isGroup=id=> (RAW.find(t=>t[0]==id)||[])[5]===1;
const groupDone=id=>{
  const kids=children(id);
  return kids.length>0 && kids.every(t=> t[5]===1 ? groupDone(t[0]) : doneSet.has(t[0]));
};

const STORAGE_KEY="kbb_allinone_done";
let doneSet=new Set(JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]"));
let SCALE="day", QUERY="";

/* Scale constants */
const ROW_H = 32, H_MONTH=28, H_SCALE=26;
const PX =()=> SCALE==="day"?30 : (SCALE==="week"?10:4); /* px per day */

/* ================ RENDER ================ */
function render(){
  const gantt=$("#gantt"); gantt.innerHTML="";
  const table=document.createElement("div"); table.className="table"; gantt.appendChild(table);
  const left=document.createElement("div"); left.className="left"; table.appendChild(left);
  const right=document.createElement("div"); right.className="right"; table.appendChild(right);

  /* Header timeline */
  const rh=document.createElement("div"); rh.className="rh"; right.appendChild(rh);
  rh.appendChild(buildHeader()); // adds month + scale bars

  const rgrid=document.createElement("div"); rgrid.className="rgrid"; right.appendChild(rgrid);

  /* Today line inside rgrid (height = rows area) */
  const filtered = RAW.filter(t=>t[1].toLowerCase().includes(QUERY.toLowerCase()));
  const rows = filtered;
  const rowsHeight = rows.length * ROW_H;
  const tl=document.createElement("div"); tl.className="tl";
  tl.style.top = "0px"; tl.style.height = rowsHeight+"px";
  tl.style.left = (Math.floor((new Date()-parse(startProj))/86400000)*PX())+"px";
  rgrid.appendChild(tl);

  /* LEFT labels + RIGHT rows */
  rows.forEach((t)=>{
    const [id,name,s,e,prog,group,parent,dep]=t;
    const lr=document.createElement("div"); lr.className="lrow"; if(group) lr.classList.add("group");
    lr.textContent=name; left.appendChild(lr);
    const rr=document.createElement("div"); rr.className="rrow"; rgrid.appendChild(rr);
  });

  /* Bars rendered AFTER rows using pure math (no DOM offsets) */
  const totalDays = dDiff(startProj,endProj)+1;
  const headerH = H_MONTH + H_SCALE; // used only for scrollbar spacing; bars live in rgrid which starts below header already
  const px = PX();
  rows.forEach((t,idx)=>{
    const [id,name,s,e,prog,group,parent,dep]=t;
    const leftPx = dDiff(startProj,s)*px;
    const widthPx = dBetween(s,e)*px;
    const yCenter = idx*ROW_H + ROW_H/2;

    const bar=document.createElement("div");
    bar.className="bar";
    const done = doneSet.has(id) || (group && groupDone(id));
    if(done) bar.classList.add("done");
    bar.style.left = leftPx+"px";
    bar.style.width = widthPx+"px";
    bar.style.top = yCenter+"px";
    bar.dataset.id=id;

    /* Tooltip + Toggle */
    bar.addEventListener("mouseenter",ev=>showTip(ev,t));
    bar.addEventListener("mouseleave",hideTips);
    bar.addEventListener("click",ev=>{
      if(group) return; // toggle only leaf
      if(doneSet.has(id)) doneSet.delete(id); else doneSet.add(id);
      localStorage.setItem(STORAGE_KEY,JSON.stringify([...doneSet]));
      render(); showTip(ev,t);
    });

    rgrid.appendChild(bar);
  });

  /* Header numbers */
  $("#duration").textContent = (dDiff(startProj,endProj)+1)+" hari";
  const leaves=RAW.filter(t=>t[5]===0);
  const pct=Math.round(100*leaves.filter(t=>doneSet.has(t[0])).length/(leaves.length||1));
  $("#overallChip").textContent="Overall: "+pct+"%"; $("#statusNum").textContent=pct+"%";
}

/* Build header (months + sub-scale) */
function buildHeader(){
  const wrap=document.createElement("div");
  const px=PX(), totalW=(dDiff(startProj,endProj)+1)*px;

  /* Months */
  const mbar=document.createElement("div"); mbar.className="monthbar"; mbar.style.width=totalW+"px";
  let cur=new Date(startProj+"T00:00:00"), last=new Date(endProj+"T00:00:00");
  while(cur<=last){
    const y=cur.getFullYear(), m=cur.getMonth()+1;
    const next=new Date(y,m,1);
    const segDays = Math.min(dDiff(cur.toISOString().slice(0,10), endProj)+1, dDiff(cur.toISOString().slice(0,10), next.toISOString().slice(0,10)));
    const seg=document.createElement("div"); seg.className="seg"; seg.style.width=(segDays*px)+"px";
    seg.textContent=new Intl.DateTimeFormat('en',{month:'short',year:'2-digit'}).format(cur);
    mbar.appendChild(seg); cur=next;
  }
  wrap.appendChild(mbar);

  /* Scale 2 (weeks/days) */
  const s2=document.createElement("div"); s2.className="scale2"; s2.style.width=totalW+"px";
  if(SCALE==="day"){
    for(let d=0; d<totalW/px; d++){
      const seg=document.createElement("div"); seg.className="seg"; seg.style.width=px+"px"; seg.textContent=(d+1);
      s2.appendChild(seg);
    }
  }else if(SCALE==="week"){
    const totalWeeks = Math.ceil((dDiff(startProj,endProj)+1)/7);
    for(let w=1; w<=totalWeeks; w++){
      const seg=document.createElement("div"); seg.className="seg"; seg.style.width=(7*px)+"px"; seg.textContent="W"+w;
      s2.appendChild(seg);
    }
  }else{ // month scale thin markers
    for(let i=0;i<Math.ceil((dDiff(startProj,endProj)+1)/30);i++){
      const seg=document.createElement("div"); seg.className="seg"; seg.style.width=(30*px)+"px"; seg.textContent="";
      s2.appendChild(seg);
    }
  }
  wrap.appendChild(s2);
  return wrap;
}

/* Tooltip helpers */
function hideTips(){ document.querySelectorAll('.tooltip').forEach(x=>x.remove()); }
function showTip(ev,t){
  hideTips();
  const [id,name,s,e,prog,group,parent,dep]=t; const dur=dBetween(s,e);
  const tip=document.createElement("div"); tip.className="tooltip";
  tip.innerHTML = `<strong>${name}</strong><br>
    üìÖ ${s} ‚Üí ${e} (${dur} hari)<br>
    üß± Group: ${nameMap[parent]||"-"}<br>
    üîó Dep: ${dep||"-"}<br>` + (!group? `<button>${doneSet.has(id)?'Mark as Not Done':'Mark Done'}</button>`:"<span class='small'>Group auto-complete bila semua subtask siap</span>");
  document.body.appendChild(tip);
  const r=ev.target.getBoundingClientRect();
  tip.style.left=(r.left+window.scrollX+12)+"px";
  tip.style.top=(r.top+window.scrollY-10)+"px";
  const btn=tip.querySelector("button");
  if(btn){ btn.onclick=()=>{ if(doneSet.has(id)) doneSet.delete(id); else doneSet.add(id); localStorage.setItem(STORAGE_KEY,JSON.stringify([...doneSet])); render(); }; }
}

/* Events */
$("#search").addEventListener("input",e=>{ QUERY=e.target.value; render(); });
$$(".button-group .button").forEach(b=>b.addEventListener("click",()=>{
  $$(".button-group .button").forEach(x=>x.classList.remove("active"));
  b.classList.add("active"); SCALE=b.dataset.scale; render();
}));
$("#resetBtn").addEventListener("click",()=>{ if(confirm("Reset semua progress?")){ localStorage.removeItem(STORAGE_KEY); doneSet=new Set(); render(); }});

/* First paint */
render();
</script>
</body></html>
